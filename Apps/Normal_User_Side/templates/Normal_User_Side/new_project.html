{% extends 'Normal_User_Side/base_dashboard.html' %}
{% load static %}

{% block title %}Create New Land Appraisal - Land Appraisal System{% endblock %}

{% block content %}
<!-- Hero Section with Gradient Blobs -->
<div class="bg-background"
    style="position: relative; overflow: hidden; padding: var(--spacing-8) 0; margin: calc(var(--spacing-8) * -1) calc(var(--spacing-4) * -1) var(--spacing-8);">
    <!-- Gradient Blobs -->
    <div
        style="position: absolute; top: -20%; right: -10%; width: 500px; height: 500px; background: var(--blob-gradient-1); opacity: 0.4; z-index: -1;">
    </div>
    <div
        style="position: absolute; bottom: -20%; left: -10%; width: 500px; height: 500px; background: var(--blob-gradient-2); opacity: 0.4; z-index: -1;">
    </div>

    <!-- Page Header Card -->
    <div class="container">
        <div class="card card-glass"
            style="padding: var(--spacing-8); border-radius: var(--radius-xl); max-width: 1000px; margin: 0 auto;">
            <!-- Back Button -->
            <a href="{% url 'normal:dashboard' %}" class="inline-flex items-center gap-2 mb-4"
                style="color: var(--color-primary-500); text-decoration: none; font-weight: 500; font-size: 0.875rem;">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Dashboard
            </a>

            <div class="text-center">
                <span style="font-size: 2rem;">ðŸ“‹</span>
                {% if is_edit %}
                <h1 class="text-3xl font-bold mb-2"
                    style="color: var(--color-text-main); margin-top: var(--spacing-2);">Edit Project</h1>
                {% else %}
                <h1 class="text-3xl font-bold mb-2"
                    style="color: var(--color-text-main); margin-top: var(--spacing-2);">Create New Project</h1>
                {% endif %}

                <p class="text-muted-foreground">Fill in the details below to start your land price estimation</p>
            </div>
        </div>
    </div>
</div>
<!--  Message if exists -->
<div class="container mb-6">
    {% if messages %}
    <div>
        {% for message in messages %}
        <p class="error-message text-center">{{ message }}</p>
        {% endfor %}
    </div>
    {% endif %}
</div>
<!-- Form Section -->
<div class="container" style="max-width: 1000px; margin: 0 auto;">
    <form method="POST" action="">
        {% csrf_token %}



        <!-- Project Details Card -->
        <div class="card card-glass mb-6" style="padding: var(--spacing-8); border-radius: var(--radius-xl);">
            <h2 class="text-xl font-semibold mb-6"
                style="color: var(--color-text-main); display: flex; align-items: center; gap: var(--spacing-2);">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="color: var(--color-primary-500);">
                    <path
                        d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
                    <line x1="12" y1="22.08" x2="12" y2="12" />
                </svg>
                Project Details
            </h2>

            <!-- Project Name -->
            <div class="form-group">
                <label class="form-label" style="display: flex; align-items: center; gap: var(--spacing-2);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="color: var(--color-primary-500);">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                        <polyline points="10 9 9 9 8 9" />
                    </svg>
                    {{ form.project_name.label }} *
                </label>
                {{ form.project_name }}
                {% if form.project_name.errors %}
                <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">{{ form.project_name.errors
                    }}</p>
                {% endif %}
            </div>

            <!-- Description -->
            <div class="form-group">
                <label class="form-label" style="display: flex; align-items: center; gap: var(--spacing-2);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="color: var(--color-primary-500);">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                    </svg>
                    {{ form.description.label }}
                </label>
                {{ form.description }}
            </div>
        </div>

        <!-- Location & Parcel Information Card -->
        <div class="card card-glass mb-6" style="padding: var(--spacing-8); border-radius: var(--radius-xl);">
            <h2 class="text-xl font-semibold mb-6"
                style="color: var(--color-text-main); display: flex; align-items: center; gap: var(--spacing-2);">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="color: var(--color-primary-500);">
                    <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" />
                    <circle cx="12" cy="10" r="3" />
                </svg>
                Location & Parcel Information
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Governorate -->
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: var(--spacing-2);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            style="color: var(--color-primary-500);">
                            <polygon points="3 11 22 2 13 21 11 13 3 11" />
                        </svg>
                        {{ form.governorate.label }}
                    </label>
                    {{ form.governorate }}
                    <p style="color: var(--color-text-muted); font-size: 0.75rem; margin-top: 4px;">
                        {{ form.governorate.help_text }}
                    </p>
                    {% if form.governorate.errors %}
                    <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">{{
                        form.governorate.errors }}</p>
                    {% endif %}
                </div>

                <!-- Town -->
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: var(--spacing-2);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            style="color: var(--color-primary-500);">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                            <polyline points="9 22 9 12 15 12 15 22" />
                        </svg>
                        {{ form.town.label }}
                    </label>
                    {{ form.town }}
                    <p style="color: var(--color-text-muted); font-size: 0.75rem; margin-top: 4px;">
                        {{ form.town.help_text }}
                    </p>
                    {% if form.town.errors %}
                    <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">{{ form.town.errors }}
                    </p>
                    {% endif %}
                </div>

                <!-- Area -->
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: var(--spacing-2);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            style="color: var(--color-primary-500);">
                            <circle cx="12" cy="10" r="3" />
                            <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 6.9 8 11.7z" />
                        </svg>
                        {{ form.area.label }}
                    </label>
                    {{ form.area }}
                    <p style="color: var(--color-text-muted); font-size: 0.75rem; margin-top: 4px;">
                        {{ form.area.help_text }}
                    </p>
                    {% if form.area.errors %}
                    <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">{{ form.area.errors }}
                    </p>
                    {% endif %}
                </div>

                <!-- Neighborhood -->
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: var(--spacing-2);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            style="color: var(--color-primary-500);">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                            <rect x="7" y="10" width="3" height="4" />
                            <rect x="14" y="10" width="3" height="4" />
                        </svg>
                        {{ form.neighborhood.label }} *
                    </label>
                    {{ form.neighborhood }}
                    {% if form.neighborhood.errors %}
                    <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">{{
                        form.neighborhood.errors }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Parcel Identification (full width below location) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" style="margin-top: var(--spacing-6);">

                <!-- Neighborhood Number (Read-Only Display + Hidden Form Field) -->
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: var(--spacing-2);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            style="color: var(--color-primary-500);">
                            <path d="M4 7V4a2 2 0 0 1 2-2h8.5L20 7.5V20a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-3" />
                            <path d="M14 2v6h6" />
                            <path d="M3 15h6" />
                        </svg>
                        Neighborhood Number
                    </label>
                    <!-- Hidden field that actually submits to the form -->
                    <input type="hidden" name="neighborhood_no" id="id_neighborhood_no"
                        value="{{ form.neighborhood_no.value|default:'' }}">
                    <!-- Display field (read-only) -->
                    <input type="text" id="neighborhood_number_display" class="form-input" readonly disabled
                        placeholder="Auto-fills on neighborhood pick"
                        style="background: var(--color-secondary-100); cursor: not-allowed; max-width: 300px;"
                        value="{{ form.neighborhood_no.value|default:'' }}">
                    {% if form.neighborhood_no.errors %}
                    <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">
                        {{ form.neighborhood_no.errors }}</p>
                    {% endif %}
                    <p style="color: var(--color-text-muted); font-size: 0.75rem; margin-top: 4px;">
                        This number is assigned by administrators and cannot be changed.
                    </p>
                </div>

                <!-- Parcel Number -->
                <div class="form-group">
                    <label class="form-label">{{ form.parcel_no.label }} *</label>
                    {{ form.parcel_no }}
                    {% if form.parcel_no.errors %}
                    <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">
                        {{form.parcel_no.errors}}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Land Attributes Card -->
        <div class="card card-glass mb-6" style="padding: var(--spacing-8); border-radius: var(--radius-xl);">
            <h2 class="text-xl font-semibold mb-6"
                style="color: var(--color-text-main); display: flex; align-items: center; gap: var(--spacing-2);">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="color: var(--color-primary-500);">
                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
                </svg>
                Land Attributes
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Land Area -->
                <div class="form-group">
                    <label class="form-label">{{ form.area_m2.label }} *</label>
                    {{ form.area_m2 }}
                    {% if form.area_m2.errors %}
                    <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">{{ form.area_m2.errors
                        }}</p>
                    {% endif %}
                </div>

                <!-- Parcel Frontage -->
                <div class="form-group">
                    <label class="form-label">{{ form.parcel_frontage.label }}</label>
                    {{ form.parcel_frontage }}
                    {% if form.parcel_frontage.errors %}
                    <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">{{
                        form.parcel_frontage.errors }}</p>
                    {% endif %}
                    <p style="color: var(--color-text-muted); font-size: 0.75rem; margin-top: 2px;">Optional: width of
                        the land parcel facing a road</p>
                </div>

                <!-- Land Type -->
                <div class="form-group">
                    <label class="form-label">{{ form.land_type.label }} *</label>
                    {{ form.land_type }}
                    {% if form.land_type.errors %}
                    <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">{{
                        form.land_type.errors }}</p>
                    {% endif %}
                </div>

                <!-- Political Classification -->
                <div class="form-group">
                    <label class="form-label">{{ form.political_classification.label }} *</label>
                    {{ form.political_classification }}
                    {% if form.political_classification.errors %}
                    <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">{{
                        form.political_classification.errors }}</p>
                    {% endif %}
                </div>

                <!-- Slope -->
                <div class="form-group">
                    <label class="form-label">{{ form.slope.label }} *</label>
                    {{ form.slope }}
                    {% if form.slope.errors %}
                    <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">{{ form.slope.errors }}
                    </p>
                    {% endif %}
                </div>

                <!-- View Quality -->
                <div class="form-group">
                    <label class="form-label">{{ form.view_quality.label }} *</label>
                    {{ form.view_quality }}
                    {% if form.view_quality.errors %}
                    <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">{{
                        form.view_quality.errors }}</p>
                    {% endif %}
                </div>

                <!-- Parcel Shape -->
                <div class="form-group">
                    <label class="form-label">{{ form.parcel_shape.label }} *</label>
                    {{ form.parcel_shape }}
                    {% if form.parcel_shape.errors %}
                    <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">{{
                        form.parcel_shape.errors }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Utilities Card -->
        <div class="card card-glass mb-6" style="padding: var(--spacing-8); border-radius: var(--radius-xl);">
            <h2 class="text-xl font-semibold mb-6"
                style="color: var(--color-text-main); display: flex; align-items: center; gap: var(--spacing-2);">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="color: var(--color-primary-500);">
                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
                </svg>
                Utilities
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Electricity -->
                <div class="form-group">
                    <label class="form-label">{{ form.electricity.label }} *</label>
                    {{ form.electricity }}
                    {% if form.electricity.errors %}
                    <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">{{
                        form.electricity.errors }}</p>
                    {% endif %}
                </div>

                <!-- Water -->
                <div class="form-group">
                    <label class="form-label">{{ form.water.label }} *</label>
                    {{ form.water }}
                    {% if form.water.errors %}
                    <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">{{ form.water.errors }}
                    </p>
                    {% endif %}
                </div>

                <!-- Sewage -->
                <div class="form-group">
                    <label class="form-label">{{ form.sewage.label }} *</label>
                    {{ form.sewage }}
                    {% if form.sewage.errors %}
                    <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">{{ form.sewage.errors
                        }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Land Uses Card -->
        <div class="card card-glass mb-6" style="padding: var(--spacing-8); border-radius: var(--radius-xl);">
            <h3 class="text-lg font-semibold mb-4"
                style="color: var(--color-text-main); display: flex; align-items: center; gap: var(--spacing-2);">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="color: var(--color-primary-500);">
                    <path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" />
                    <path d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z" />
                </svg>
                Intended Land Uses *
            </h3>
            <p style="color: var(--color-text-muted); font-size: 0.875rem; margin-bottom: var(--spacing-4);">
                Select one or more intended uses for this land
            </p>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Residential -->
                <div
                    style="display: flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-3); background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                    {{ form.land_use_residential }}
                    <label for="{{ form.land_use_residential.id_for_label }}"
                        style="cursor: pointer; color: var(--color-text-main); font-size: 0.9375rem;">
                        {{ form.land_use_residential.label }}
                    </label>
                </div>
                <!-- Commercial -->
                <div
                    style="display: flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-3); background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                    {{ form.land_use_commercial }}
                    <label for="{{ form.land_use_commercial.id_for_label }}"
                        style="cursor: pointer; color: var(--color-text-main); font-size: 0.9375rem;">
                        {{ form.land_use_commercial.label }}
                    </label>
                </div>
                <!-- Agricultural -->
                <div
                    style="display: flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-3); background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                    {{ form.land_use_agricultural }}
                    <label for="{{ form.land_use_agricultural.id_for_label }}"
                        style="cursor: pointer; color: var(--color-text-main); font-size: 0.9375rem;">
                        {{ form.land_use_agricultural.label }}
                    </label>
                </div>
                <!-- Industrial -->
                <div
                    style="display: flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-3); background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                    {{ form.land_use_industrial }}
                    <label for="{{ form.land_use_industrial.id_for_label }}"
                        style="cursor: pointer; color: var(--color-text-main); font-size: 0.9375rem;">
                        {{ form.land_use_industrial.label }}
                    </label>
                </div>
            </div>
            {% if form.errors %}
            <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: var(--spacing-2);">
                {{ form.non_field_errors }}
            </p>
            {% endif %}
        </div>

        <!-- Facilities Card -->
        <div class="card card-glass mb-6" style="padding: var(--spacing-8); border-radius: var(--radius-xl);">
            <h3 class="text-lg font-semibold mb-4"
                style="color: var(--color-text-main); display: flex; align-items: center; gap: var(--spacing-2);">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="color: var(--color-primary-500);">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                    <polyline points="9 22 9 12 15 12 15 22" />
                </svg>
                Nearby Facilities
            </h3>
            <p style="color: var(--color-text-muted); font-size: 0.875rem; margin-bottom: var(--spacing-4);">
                Select all facilities near this land
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Hospitals -->
                <div
                    style="display: flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-3); background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                    {{ form.hospitals_facility }}
                    <label for="{{ form.hospitals_facility.id_for_label }}"
                        style="cursor: pointer; color: var(--color-text-main); font-size: 0.9375rem;">
                        {{ form.hospitals_facility.label }}
                    </label>
                </div>
                <!-- Schools -->
                <div
                    style="display: flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-3); background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                    {{ form.schools_facility }}
                    <label for="{{ form.schools_facility.id_for_label }}"
                        style="cursor: pointer; color: var(--color-text-main); font-size: 0.9375rem;">
                        {{ form.schools_facility.label }}
                    </label>
                </div>
                <!-- Police -->
                <div
                    style="display: flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-3); background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                    {{ form.police_facility }}
                    <label for="{{ form.police_facility.id_for_label }}"
                        style="cursor: pointer; color: var(--color-text-main); font-size: 0.9375rem;">
                        {{ form.police_facility.label }}
                    </label>
                </div>
                <!-- Municipality -->
                <div
                    style="display: flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-3); background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                    {{ form.municipality_facility }}
                    <label for="{{ form.municipality_facility.id_for_label }}"
                        style="cursor: pointer; color: var(--color-text-main); font-size: 0.9375rem;">
                        {{ form.municipality_facility.label }}
                    </label>
                </div>
            </div>
        </div>

        <!-- Environmental Factors Card -->
        <div class="card card-glass mb-6" style="padding: var(--spacing-8); border-radius: var(--radius-xl);">
            <h3 class="text-lg font-semibold mb-4"
                style="color: var(--color-text-main); display: flex; align-items: center; gap: var(--spacing-2);">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="color: var(--color-primary-500);">
                    <path d="M17 18a5 5 0 0 0-10 0" />
                    <line x1="12" y1="9" x2="12" y2="2" />
                    <line x1="4.22" y1="10.22" x2="5.64" y2="11.64" />
                    <line x1="1" y1="18" x2="3" y2="18" />
                    <line x1="21" y1="18" x2="23" y2="18" />
                    <line x1="18.36" y1="11.64" x2="19.78" y2="10.22" />
                    <line x1="23" y1="22" x2="1" y2="22" />
                    <polyline points="16 5 12 9 8 5" />
                </svg>
                Environmental Factors
            </h3>
            <p style="color: var(--color-text-muted); font-size: 0.875rem; margin-bottom: var(--spacing-4);">
                Select all applicable environmental factors (negative impacts)
            </p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Factories Nearby -->
                <div
                    style="display: flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-3); background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                    {{ form.FACTORIES_NEARBY }}
                    <label for="{{ form.FACTORIES_NEARBY.id_for_label }}"
                        style="cursor: pointer; color: var(--color-text-main); font-size: 0.9375rem;">
                        {{ form.FACTORIES_NEARBY.label }}
                    </label>
                </div>
                <!-- Noisy Facilities -->
                <div
                    style="display: flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-3); background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                    {{ form.NOISY_FACILITIES }}
                    <label for="{{ form.NOISY_FACILITIES.id_for_label }}"
                        style="cursor: pointer; color: var(--color-text-main); font-size: 0.9375rem;">
                        {{ form.NOISY_FACILITIES.label }}
                    </label>
                </div>
                <!-- Animal Farms -->
                <div
                    style="display: flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-3); background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                    {{ form.ANIMAL_FARMS }}
                    <label for="{{ form.ANIMAL_FARMS.id_for_label }}"
                        style="cursor: pointer; color: var(--color-text-main); font-size: 0.9375rem;">
                        {{ form.ANIMAL_FARMS.label }}
                    </label>
                </div>
            </div>
        </div>


        <!-- Roads Card -->
        <div class="card card-glass mb-6" style="padding: var(--spacing-8); border-radius: var(--radius-xl);">
            <div
                style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--spacing-4);">
                <h3 class="text-lg font-semibold"
                    style="color: var(--color-text-main); display: flex; align-items: center; gap: var(--spacing-2); margin: 0;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="color: var(--color-primary-500);">
                        <path d="M4 19L20 19" />
                        <path d="M4 15L20 15" />
                        <path d="M12 3L12 19" />
                        <path d="M8 3L8 7" />
                        <path d="M16 3L16 7" />
                    </svg>
                    Road Access
                </h3>
                <button type="button" id="add-road-btn" class="btn btn-secondary"
                    style="padding: var(--spacing-2) var(--spacing-4); font-size: 0.875rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="margin-right: 4px;">
                        <path d="M12 4v16m8-8H4" />
                    </svg>
                    Add Road
                </button>
            </div>
            <p style="color: var(--color-text-muted); font-size: 0.875rem; margin-bottom: var(--spacing-4);">
                Add up to 3 roads adjacent to this land parcel. Each road's status and width affects the valuation.
            </p>

            {{ road_formset.management_form }}
            <div id="road-forms-container">
                {% for road_form in road_formset %}
                <div class="road-form-item{% if road_form.DELETE.value %} hidden{% endif %}"
                    style="background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: var(--spacing-4); margin-bottom: var(--spacing-3); position: relative;">
                    {{ road_form.id }}

                    <div style="display: flex; align-items: flex-start; gap: var(--spacing-4);">
                        <!-- Road Icon -->
                        <div
                            style="width: 40px; height: 40px; border-radius: var(--radius-md); background: linear-gradient(135deg, var(--color-primary-100), var(--color-primary-200)); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="var(--color-primary-600)" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M4 19L20 19" />
                                <path d="M4 15L20 15" />
                                <path d="M12 3L12 19" />
                            </svg>
                        </div>

                        <!-- Road Fields -->
                        <div style="flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4);">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" style="font-size: 0.875rem; margin-bottom: var(--spacing-1);">
                                    {{ road_form.road_status.label }}
                                </label>
                                {{ road_form.road_status }}
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" style="font-size: 0.875rem; margin-bottom: var(--spacing-1);">
                                    {{ road_form.width_m.label }}
                                </label>
                                {{ road_form.width_m }}
                            </div>
                        </div>

                        <!-- Delete Button -->
                        {% if road_formset.can_delete %}
                        <div style="flex-shrink: 0;">
                            <label
                                style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer; padding: var(--spacing-2); border-radius: var(--radius-md); transition: background 0.2s;"
                                class="road-delete-label"
                                onmouseover="this.style.background='var(--color-danger)'; this.style.color='white';"
                                onmouseout="this.style.background='transparent'; this.style.color='var(--color-text-muted)';">
                                {{ road_form.DELETE }}
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M3 6h18" />
                                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                                </svg>
                                <span style="font-size: 0.75rem;">Remove</span>
                            </label>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div id="no-roads-message"
                    style="padding: var(--spacing-6); background: var(--color-secondary-50); border-radius: var(--radius-lg); text-align: center;">
                    <p style="color: var(--color-text-muted); margin: 0;">No roads added yet. Click "Add Road" to add
                        road access information.</p>
                </div>
                {% endfor %}
            </div>

            <!-- Road count indicator -->
            <div id="road-count-info"
                style="margin-top: var(--spacing-3); font-size: 0.75rem; color: var(--color-text-muted); text-align: right;">
                <span id="visible-road-count">0</span>/3 roads added
            </div>
        </div>



        <!-- Ownership & Pricing Card -->
        <div class="card card-glass mb-6" style="padding: var(--spacing-8); border-radius: var(--radius-xl);">
            <h2 class="text-xl font-semibold mb-6"
                style="color: var(--color-text-main); display: flex; align-items: center; gap: var(--spacing-2);">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="color: var(--color-primary-500);">
                    <line x1="12" y1="1" x2="12" y2="23" />
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                </svg>
                Ownership & Pricing
            </h2>

            <!-- Ownership Document Type -->
            <div class="form-group">
                <label class="form-label">{{ form.ownership_document_type.label }} *</label>
                {{ form.ownership_document_type }}
                {% if form.ownership_document_type.errors %}
                <p style="color: var(--color-danger); font-size: 0.875rem; margin-top: 4px;">{{
                    form.ownership_document_type.errors }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card card-glass" style="padding: var(--spacing-6); border-radius: var(--radius-xl);">
            <div class="flex gap-4" style="display: flex; gap: var(--spacing-4); flex-wrap: wrap;">
                <button type="submit" name="action" value="save" class="btn btn-secondary"
                    style="flex: 1; min-width: 200px; display: inline-flex; align-items: center; justify-content: center; gap: var(--spacing-2);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                        <polyline points="17 21 17 13 7 13 7 21" />
                        <polyline points="7 3 7 8 15 8" />
                    </svg>
                    Save as Draft
                </button>

                <button type="button" id="complete-btn" class="btn btn-primary"
                    style="flex: 1; min-width: 200px; display: inline-flex; align-items: center; justify-content: center; gap: var(--spacing-2);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12" />
                    </svg>
                    Save as Completed
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Price Prediction Modal -->
<div id="prediction-modal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <div style="display: flex; align-items: center; gap: var(--spacing-3);">
                <div
                    style="width: 48px; height: 48px; border-radius: var(--radius-lg); background: linear-gradient(135deg, var(--color-primary-500), var(--color-primary-600)); display: flex; align-items: center; justify-content: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="1" x2="12" y2="23" />
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                    </svg>
                </div>
                <div>
                    <h2 style="margin: 0; font-size: 1.5rem; color: var(--color-text-main);">Price Estimation</h2>
                    <p style="margin: 0; font-size: 0.875rem; color: var(--color-text-muted);">ML Model Prediction
                        Result</p>
                </div>
            </div>
            <button type="button" id="modal-close-btn" class="modal-close-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
            </button>
        </div>

        <div class="modal-body">
            <!-- Project Info -->
            <div class="modal-info-card">
                <h4
                    style="margin: 0 0 var(--spacing-3) 0; color: var(--color-text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">
                    Project Details</h4>
                <p style="margin: 0; font-size: 1.125rem; font-weight: 600; color: var(--color-text-main);"
                    id="modal-project-name"></p>
                <p style="margin: var(--spacing-1) 0 0 0; font-size: 0.875rem; color: var(--color-text-muted);">
                    <span id="modal-neighborhood"></span> â€¢ Parcel: <span id="modal-parcel-no"></span>
                </p>
            </div>

            <!-- Price Display -->
            <div class="modal-price-display">
                <div class="price-card price-card-main">
                    <span class="price-label">Estimated Price per mÂ²</span>
                    <span class="price-value" id="modal-price-per-m2">0.00</span>
                    <span class="price-unit">JOD/mÂ²</span>
                </div>
                <div class="price-card-row">
                    <div class="price-card price-card-secondary">
                        <span class="price-label">Land Area</span>
                        <span class="price-value-sm" id="modal-area-m2">0</span>
                        <span class="price-unit">mÂ²</span>
                    </div>
                    <div class="price-card price-card-secondary">
                        <span class="price-label">Total Parcel Value</span>
                        <span class="price-value-sm" id="modal-total-value">0.00</span>
                        <span class="price-unit">JOD</span>
                    </div>
                </div>
            </div>

            <!-- Feedback Section -->
            <div class="modal-feedback-section">
                <label
                    style="display: block; margin-bottom: var(--spacing-2); font-weight: 500; color: var(--color-text-main);">
                    Your Expected Price (Optional Feedback)
                </label>
                <p style="margin: 0 0 var(--spacing-3) 0; font-size: 0.875rem; color: var(--color-text-muted);">
                    Help improve the ML model by providing your professional estimate
                </p>
                <div style="display: flex; align-items: center; gap: var(--spacing-2);">
                    <input type="number" id="modal-expected-price" class="form-input"
                        placeholder="Enter your expected price" style="flex: 1; max-width: 300px;" min="0" step="0.01">
                    <span style="color: var(--color-text-muted);">JOD/mÂ²</span>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" id="modal-reject-btn" class="btn btn-secondary modal-btn-reject">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
                Reject & Save as Draft
            </button>
            <button type="button" id="modal-accept-btn" class="btn btn-primary modal-btn-accept">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12" />
                </svg>
                Accept & Complete
            </button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <p style="color: white; margin-top: var(--spacing-4);">Generating prediction...</p>
</div>

<style>
    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-4);
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }

        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-container {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-2xl);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        width: 100%;
        max-width: 560px;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideUp 0.3s ease;
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-6);
        border-bottom: 1px solid var(--color-border);
    }

    .modal-close-btn {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-full);
        border: none;
        background: var(--color-secondary-100);
        color: var(--color-text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .modal-close-btn:hover {
        background: var(--color-danger);
        color: white;
    }

    .modal-body {
        padding: var(--spacing-6);
    }

    .modal-info-card {
        background: var(--color-secondary-50);
        border-radius: var(--radius-lg);
        padding: var(--spacing-4);
        margin-bottom: var(--spacing-6);
    }

    .modal-price-display {
        margin-bottom: var(--spacing-6);
    }

    .price-card {
        text-align: center;
        padding: var(--spacing-4);
        border-radius: var(--radius-lg);
    }

    .price-card-main {
        background: linear-gradient(135deg, var(--color-primary-500), var(--color-primary-600));
        color: white;
        margin-bottom: var(--spacing-3);
    }

    .price-card-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-3);
    }

    .price-card-secondary {
        background: var(--color-secondary-50);
        border: 1px solid var(--color-border);
    }

    .price-label {
        display: block;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.8;
        margin-bottom: var(--spacing-1);
    }

    .price-value {
        display: block;
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1.2;
    }

    .price-value-sm {
        display: block;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--color-text-main);
    }

    .price-unit {
        display: block;
        font-size: 0.875rem;
        opacity: 0.7;
    }

    .modal-feedback-section {
        background: var(--color-secondary-50);
        border-radius: var(--radius-lg);
        padding: var(--spacing-4);
        border: 1px dashed var(--color-border);
    }

    .modal-footer {
        display: flex;
        gap: var(--spacing-3);
        padding: var(--spacing-6);
        border-top: 1px solid var(--color-border);
    }

    .modal-btn-reject,
    .modal-btn-accept {
        flex: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-2);
        padding: var(--spacing-3) var(--spacing-4);
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1001;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-top-color: var(--color-primary-500);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ==========================================
        // Cascading Dropdowns
        // ==========================================
        const governorateSelect = document.getElementById('id_governorate');
        const townSelect = document.getElementById('id_town');
        const areaSelect = document.getElementById('id_area');
        const neighborhoodSelect = document.getElementById('id_neighborhood');
        const neighborhoodNumberInput = document.getElementById('neighborhood_number_display');

        // Store initial values for edit mode
        const initialTown = townSelect ? townSelect.value : '';
        const initialArea = areaSelect ? areaSelect.value : '';
        const initialNeighborhood = neighborhoodSelect ? neighborhoodSelect.value : '';

        // Utility function to populate a select element
        function populateSelect(selectElement, data, valueField, textField, selectedValue) {
            const currentValue = selectedValue || selectElement.value;
            selectElement.innerHTML = '<option value="">---------</option>';
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueField];
                option.textContent = item[textField];
                if (item[valueField].toString() === currentValue.toString()) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }

        // Governorate change â†’ Load Towns
        if (governorateSelect) {
            governorateSelect.addEventListener('change', function () {
                const governorateId = this.value;

                // Clear dependent dropdowns
                townSelect.innerHTML = '<option value="">---------</option>';
                areaSelect.innerHTML = '<option value="">---------</option>';
                neighborhoodSelect.innerHTML = '<option value="">---------</option>';
                if (neighborhoodNumberInput) neighborhoodNumberInput.value = '';

                if (!governorateId) return;

                fetch(`{% url 'normal:api-towns' %}?governorate_id=${governorateId}`)
                    .then(response => response.json())
                    .then(data => populateSelect(townSelect, data, 'id', 'name_ar'))
                    .catch(err => console.error('Error loading towns:', err));
            });
        }

        // Town change â†’ Load Areas
        if (townSelect) {
            townSelect.addEventListener('change', function () {
                const townId = this.value;

                // Clear dependent dropdowns
                areaSelect.innerHTML = '<option value="">---------</option>';
                neighborhoodSelect.innerHTML = '<option value="">---------</option>';
                if (neighborhoodNumberInput) neighborhoodNumberInput.value = '';

                if (!townId) return;

                fetch(`{% url 'normal:api-areas' %}?town_id=${townId}`)
                    .then(response => response.json())
                    .then(data => populateSelect(areaSelect, data, 'id', 'name_ar'))
                    .catch(err => console.error('Error loading areas:', err));
            });
        }

        // Area change â†’ Load Neighborhoods
        if (areaSelect) {
            areaSelect.addEventListener('change', function () {
                const areaId = this.value;

                // Clear dependent dropdown
                neighborhoodSelect.innerHTML = '<option value="">---------</option>';
                if (neighborhoodNumberInput) neighborhoodNumberInput.value = '';

                if (!areaId) return;

                fetch(`{% url 'normal:api-neighborhoods' %}?area_id=${areaId}`)
                    .then(response => response.json())
                    .then(data => populateSelect(neighborhoodSelect, data, 'id', 'name_ar'))
                    .catch(err => console.error('Error loading neighborhoods:', err));
            });
        }

        // Neighborhood change â†’ Update number display and hidden field
        if (neighborhoodSelect) {
            neighborhoodSelect.addEventListener('change', function () {
                const neighborhoodId = this.value;
                const neighborhoodNoHidden = document.getElementById('id_neighborhood_no');

                if (!neighborhoodId) {
                    if (neighborhoodNumberInput) neighborhoodNumberInput.value = '';
                    if (neighborhoodNoHidden) neighborhoodNoHidden.value = '';
                    return;
                }

                fetch(`{% url 'normal:api-neighborhood-code' %}?neighborhood_id=${neighborhoodId}`)
                    .then(response => response.json())
                    .then(data => {
                        const numberValue = data.code || '';
                        // Update both display and hidden fields
                        if (neighborhoodNumberInput) neighborhoodNumberInput.value = numberValue;
                        if (neighborhoodNoHidden) neighborhoodNoHidden.value = numberValue;
                    })
                    .catch(err => console.error('Error loading neighborhood number:', err));
            });
        }

        // ==========================================
        // Initialize dropdowns on page load (for form errors / edit mode)
        // ==========================================
        function initializeCascadingDropdowns() {
            const governorateId = governorateSelect ? governorateSelect.value : '';
            const townId = townSelect ? townSelect.value : '';
            const areaId = areaSelect ? areaSelect.value : '';
            const neighborhoodId = neighborhoodSelect ? neighborhoodSelect.value : '';
            const neighborhoodNoHidden = document.getElementById('id_neighborhood_no');

            // If governorate is selected, load towns
            if (governorateId) {
                fetch(`{% url 'normal:api-towns' %}?governorate_id=${governorateId}`)
                    .then(response => response.json())
                    .then(data => {
                        populateSelect(townSelect, data, 'id', 'name_ar', townId);

                        // If town is selected, load areas
                        if (townId) {
                            return fetch(`{% url 'normal:api-areas' %}?town_id=${townId}`);
                        }
                    })
                    .then(response => response ? response.json() : null)
                    .then(data => {
                        if (data) {
                            populateSelect(areaSelect, data, 'id', 'name_ar', areaId);

                            // If area is selected, load neighborhoods
                            if (areaId) {
                                return fetch(`{% url 'normal:api-neighborhoods' %}?area_id=${areaId}`);
                            }
                        }
                    })
                    .then(response => response ? response.json() : null)
                    .then(data => {
                        if (data) {
                            populateSelect(neighborhoodSelect, data, 'id', 'name_ar', neighborhoodId);

                            // If neighborhood is selected, also fetch and set the neighborhood number
                            if (neighborhoodId) {
                                fetch(`{% url 'normal:api-neighborhood-code' %}?neighborhood_id=${neighborhoodId}`)
                                    .then(response => response.json())
                                    .then(codeData => {
                                        const numberValue = codeData.code || '';
                                        if (neighborhoodNumberInput) neighborhoodNumberInput.value = numberValue;
                                        if (neighborhoodNoHidden) neighborhoodNoHidden.value = numberValue;
                                    })
                                    .catch(err => console.error('Error loading neighborhood number:', err));
                            }
                        }
                    })
                    .catch(err => console.error('Error initializing dropdowns:', err));
            }
        }

        // Run initialization
        initializeCascadingDropdowns();

        // ==========================================
        // Dynamic Road Forms with Max 3 Limit
        // ==========================================
        const addRoadBtn = document.getElementById('add-road-btn');
        const roadFormsContainer = document.getElementById('road-forms-container');
        const visibleRoadCountSpan = document.getElementById('visible-road-count');
        const MAX_ROADS = 3;

        function updateRoadCount() {
            if (!roadFormsContainer) return;

            const roadForms = roadFormsContainer.querySelectorAll('.road-form-item');
            let visibleCount = 0;

            roadForms.forEach(form => {
                const deleteCheckbox = form.querySelector('input[type="checkbox"][name$="-DELETE"]');
                const isDeleted = deleteCheckbox && deleteCheckbox.checked;
                const isHidden = form.style.display === 'none';

                if (!isDeleted && !isHidden) {
                    visibleCount++;
                }
            });

            if (visibleRoadCountSpan) {
                visibleRoadCountSpan.textContent = visibleCount;
            }

            // Update button state
            if (addRoadBtn) {
                if (visibleCount >= MAX_ROADS) {
                    addRoadBtn.style.opacity = '0.5';
                    addRoadBtn.style.cursor = 'not-allowed';
                    addRoadBtn.style.pointerEvents = 'none';
                    addRoadBtn.classList.add('disabled');
                } else {
                    addRoadBtn.style.opacity = '1';
                    addRoadBtn.style.cursor = 'pointer';
                    addRoadBtn.style.pointerEvents = 'auto';
                    addRoadBtn.classList.remove('disabled');
                }
            }

            return visibleCount;
        }

        // Handle delete checkbox changes
        if (roadFormsContainer) {
            roadFormsContainer.addEventListener('change', function (e) {
                if (e.target.type === 'checkbox' && e.target.name.includes('-DELETE')) {
                    const roadFormItem = e.target.closest('.road-form-item');
                    if (roadFormItem) {
                        if (e.target.checked) {
                            roadFormItem.style.display = 'none';
                        } else {
                            roadFormItem.style.display = 'block';
                        }
                    }
                    updateRoadCount();
                }
            });
        }

        // Add Road button click
        if (addRoadBtn) {
            addRoadBtn.addEventListener('click', function (e) {
                e.preventDefault();

                const visibleCount = updateRoadCount();
                if (visibleCount >= MAX_ROADS) return;

                // Find a hidden/deleted road form to show, or the first empty one
                const roadForms = roadFormsContainer.querySelectorAll('.road-form-item');
                let foundHidden = false;

                roadForms.forEach(form => {
                    if (foundHidden) return;

                    const deleteCheckbox = form.querySelector('input[type="checkbox"][name$="-DELETE"]');
                    const isHidden = form.style.display === 'none';

                    if (isHidden && deleteCheckbox) {
                        // Uncheck delete and show the form
                        deleteCheckbox.checked = false;
                        form.style.display = 'block';
                        foundHidden = true;
                    }
                });

                updateRoadCount();
            });
        }

        // Initial count update
        updateRoadCount();

        // ==========================================
        // Price Prediction Modal Handling
        // ==========================================
        const completeBtn = document.getElementById('complete-btn');
        const modal = document.getElementById('prediction-modal');
        const loadingOverlay = document.getElementById('loading-overlay');
        const projectForm = document.getElementById('project-form');

        let currentProjectId = null;

        // Modal elements
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalRejectBtn = document.getElementById('modal-reject-btn');
        const modalAcceptBtn = document.getElementById('modal-accept-btn');
        const modalExpectedPrice = document.getElementById('modal-expected-price');

        // Show/hide helpers
        function showLoading() {
            if (loadingOverlay) loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            if (loadingOverlay) loadingOverlay.style.display = 'none';
        }

        function showModal() {
            if (modal) modal.style.display = 'flex';
        }

        function hideModal() {
            if (modal) modal.style.display = 'none';
            if (modalExpectedPrice) modalExpectedPrice.value = '';
        }

        // Format number with commas
        function formatNumber(num) {
            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Populate modal with prediction data
        function populateModal(data) {
            document.getElementById('modal-project-name').textContent = data.project_name || '';
            document.getElementById('modal-neighborhood').textContent = data.neighborhood || '';
            document.getElementById('modal-parcel-no').textContent = data.parcel_no || '';
            document.getElementById('modal-price-per-m2').textContent = formatNumber(data.predicted_price_per_m2 || 0);
            document.getElementById('modal-area-m2').textContent = formatNumber(data.area_m2 || 0);
            document.getElementById('modal-total-value').textContent = formatNumber(data.total_parcel_value || 0);
            currentProjectId = data.project_id;
        }

        // Get form for the project - find closest form to avoid selecting wrong one
        function getProjectForm() {
            return document.querySelector('form') || projectForm;
        }

        // Handle "Save as Completed" button click
        if (completeBtn) {
            completeBtn.addEventListener('click', function (e) {
                e.preventDefault();
                showLoading();

                const form = getProjectForm();
                const formData = new FormData(form);

                // Add project_id if editing
                const projectId = '{{ project.id|default:"" }}';
                if (projectId) {
                    formData.append('project_id', projectId);
                }

                fetch("{% url 'normal:api-predict-price' %}", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        hideLoading();

                        if (data.success) {
                            populateModal(data);
                            showModal();
                        } else if (data.validation_errors) {
                            // Form validation failed - show error message
                            alert(data.error || 'Please correct the errors in the form.');
                            // Optionally reload to show errors
                            window.location.reload();
                        } else {
                            alert(data.error || 'An error occurred.');
                        }
                    })
                    .catch(err => {
                        hideLoading();
                        console.error('Error:', err);
                        alert('An error occurred while generating the prediction.');
                    });
            });
        }

        // Close modal
        if (modalCloseBtn) {
            modalCloseBtn.addEventListener('click', hideModal);
        }

        // Close modal on overlay click
        if (modal) {
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    hideModal();
                }
            });
        }

        // Handle Accept
        if (modalAcceptBtn) {
            modalAcceptBtn.addEventListener('click', function () {
                if (!currentProjectId) return;

                showLoading();

                const payload = {
                    project_id: currentProjectId,
                    action: 'accept',
                    user_expected_price: modalExpectedPrice ? modalExpectedPrice.value : null
                };

                fetch("{% url 'normal:api-confirm-prediction' %}", {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        hideLoading();
                        hideModal();

                        if (data.success) {
                            window.location.href = data.redirect_url || '/normal_user/projects/';
                        } else {
                            alert(data.error || 'An error occurred.');
                        }
                    })
                    .catch(err => {
                        hideLoading();
                        console.error('Error:', err);
                        alert('An error occurred.');
                    });
            });
        }

        // Handle Reject
        if (modalRejectBtn) {
            modalRejectBtn.addEventListener('click', function () {
                if (!currentProjectId) return;

                showLoading();

                const payload = {
                    project_id: currentProjectId,
                    action: 'reject',
                    user_expected_price: modalExpectedPrice ? modalExpectedPrice.value : null
                };

                fetch("{% url 'normal:api-confirm-prediction' %}", {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        hideLoading();
                        hideModal();

                        if (data.success) {
                            window.location.href = data.redirect_url || '/normal_user/projects/';
                        } else {
                            alert(data.error || 'An error occurred.');
                        }
                    })
                    .catch(err => {
                        hideLoading();
                        console.error('Error:', err);
                        alert('An error occurred.');
                    });
            });
        }
    });
</script>
{% endblock %}