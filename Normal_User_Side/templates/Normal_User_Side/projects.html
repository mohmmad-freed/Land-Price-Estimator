{% extends 'Normal_User_Side/base_dashboard.html' %}
{% load humanize %}

{% block title %}My Projects - Land Appraisal System{% endblock %}

{% block content %}

{# ===== Land type badge styles (move gradients to CSS for maintainability) ===== #}
<style>
    .land-badge {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        box-shadow: var(--shadow-md);
        background: linear-gradient(135deg, var(--g1), var(--g2));
    }

    .land-badge--commercial {
        --g1: #6366f1;
        --g2: #4f46e5;
    }

    .land-badge--residential {
        --g1: var(--color-secondary-200);
        --g2: var(--color-secondary-400);
    }

    .land-badge--industrial {
        --g1: #f59e0b;
        --g2: #d97706;
    }

    .land-badge--other {
        --g1: var(--color-primary-400);
        --g2: var(--color-primary-600);
    }
</style>

<!-- Hero Section with Gradient Blobs -->
<div class="bg-background"
    style="position: relative; overflow: hidden; padding: var(--spacing-8) 0; margin: calc(var(--spacing-8) * -1) calc(var(--spacing-4) * -1) var(--spacing-8);">
    <!-- Gradient Blobs -->
    <div
        style="position: absolute; top: -20%; right: -10%; width: 500px; height: 500px; background: var(--blob-gradient-1); opacity: 0.4; z-index: -1;">
    </div>
    <div
        style="position: absolute; bottom: -20%; left: -10%; width: 500px; height: 500px; background: var(--blob-gradient-2); opacity: 0.4; z-index: -1;">
    </div>

    <!-- Page Header Card -->
    <div class="container">
        <div class="card card-glass"
            style="padding: var(--spacing-8); border-radius: var(--radius-xl); max-width: 900px; margin: 0 auto;">
            <!-- Back Button -->
            <a href="{% url 'normal_user:dashboard' %}" class="inline-flex items-center gap-2 mb-4"
                style="color: var(--color-primary-500); text-decoration: none; font-weight: 500; font-size: 0.875rem;">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Dashboard
            </a>

            <div
                style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-4);">
                <div>
                    <span style="font-size: 2rem;">📊</span>
                    <h1 class="text-3xl font-bold mb-2"
                        style="color: var(--color-text-main); margin-top: var(--spacing-2);">My Projects</h1>
                    <p class="text-muted-foreground">Manage and continue your land appraisal projects</p>
                </div>
                <a href="{% url 'normal_user:new-project' %}" class="btn btn-primary"
                    style="display: inline-flex; align-items: center; gap: var(--spacing-2);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        aria-hidden="true">
                        <path d="M12 4v16m8-8H4"></path>
                    </svg>
                    New Project
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Filters Section -->
<div class="container mb-8">
    <div class="card card-glass" style="padding: var(--spacing-6); border-radius: var(--radius-xl);">
        <form method="GET" class="space-y-4">
            <!-- Search Input -->
            <div style="position: relative;">
                <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Search projects..."
                    class="form-input" style="width: 100%; padding-left: 2.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted);"
                    aria-hidden="true">
                    <circle cx="11" cy="11" r="8" />
                    <path d="m21 21-4.35-4.35" />
                </svg>
            </div>

            <!-- Filter Dropdowns -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Land Type -->
                <select name="land_type" class="form-select">
                    <option value="">All Land Types</option>
                    {% for code, name in land_types %}
                    <option value="{{ code }}" {% if request.GET.land_type == code %}selected{% endif %}>
                        {{ name }}
                    </option>
                    {% endfor %}
                </select>

                <!-- Political Classification -->
                <select name="political_type" class="form-select">
                    <option value="">All Classifications</option>
                    {% for code, name in political_types %}
                    <option value="{{ code }}" {% if request.GET.political_type == code %}selected{% endif %}>
                        {{ name }}
                    </option>
                    {% endfor %}
                </select>

                <!-- Status -->
                <select name="status" class="form-select">
                    <option value="">All Statuses</option>
                    {% for code, name in statuses %}
                    <option value="{{ code }}" {% if request.GET.status == code %}selected{% endif %}>
                        {{ name }}
                    </option>
                    {% endfor %}
                </select>

                <!-- Sort -->
                <select name="sort" class="form-select">
                    <option value="-created_at" {% if request.GET.sort == '-created_at' %}selected{% endif %}>
                        Newest First</option>
                    <option value="created_at" {% if request.GET.sort == 'created_at' %}selected{% endif %}>
                        Oldest First</option>
                </select>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-2 flex-wrap">
                <button type="submit" class="btn btn-primary">Apply Filters</button>
                <a href="{% url 'normal_user:projects' %}" class="btn btn-secondary">Clear</a>
            </div>
        </form>
    </div>
</div>

<!-- Projects Count -->
<div class="container mb-4">
    <p class="text-muted-foreground" style="font-size: 0.875rem;">
        Showing {{ projects|length }} project{{ projects|pluralize }}
    </p>
</div>

<!-- Projects Grid -->
<div class="container mb-8">
    {% if projects %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for project in projects %}
        <!-- Project Card -->
        <div class="card card-glass hover:shadow-lg transition-all"
            style="padding: 0; overflow: hidden; position: relative;">
            <!-- Status Badge - Floating -->
            <div style="position: absolute; top: var(--spacing-4); right: var(--spacing-4); z-index: 10;">
                {% if project.status == 'completed' %}
                <div
                    style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: var(--radius-full); background: linear-gradient(135deg, var(--color-primary-400), var(--color-primary-600)); color: white; font-size: 0.75rem; font-weight: 600; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        aria-hidden="true">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                        <polyline points="22 4 12 14.01 9 11.01" />
                    </svg>
                    Completed
                </div>
                {% else %}
                <div
                    style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: var(--radius-full); background: linear-gradient(135deg, #f59e0b, #d97706); color: white; font-size: 0.75rem; font-weight: 600; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        aria-hidden="true">
                        <circle cx="12" cy="12" r="10" />
                        <polyline points="12 6 12 12 16 14" />
                    </svg>
                    Draft
                </div>
                {% endif %}
            </div>

            <!-- Card Content -->
            <div style="padding: var(--spacing-6);">
                <!-- Project Icon & Title -->
                <div class="flex items-start gap-4 mb-4">

                    {# Badge now uses CSS classes, no inline ifs in style #}
                    <div
                        class="land-badge land-badge--{% if project.land_type %}{{ project.land_type }}{% else %}other{% endif %}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            aria-hidden="true">

                            {% if project.land_type == 'commercial' %}
                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
                            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />

                            {% elif project.land_type == 'residential' %}
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                            <polyline points="9 22 9 12 15 12 15 22" />

                            {% elif project.land_type == 'industrial' %}
                            {# simple factory icon #}
                            <path d="M3 21V9l6 3V9l6 3V9l6 3v9H3z" />
                            <path d="M7 21v-8" />
                            <path d="M11 21v-6" />
                            <path d="M15 21v-4" />

                            {% else %}
                            <path
                                d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
                            <line x1="12" y1="22.08" x2="12" y2="12" />
                            {% endif %}
                        </svg>
                    </div>

                    <div style="flex: 1; padding-right: 80px;">
                        <h3 class="text-lg font-bold mb-1" style="color: var(--color-text-main); line-height: 1.3;">
                            {{ project.name }}
                        </h3>
                        <p class="text-sm text-muted-foreground flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                                </path>
                            </svg>
                            {{ project.get_governorate_display }}{% if project.town %}, {{ project.get_town_display }}{%
                            endif %}
                        </p>
                    </div>
                </div>

                <!-- Divider -->
                <div style="height: 1px; background: var(--color-border); margin: var(--spacing-4) 0;"></div>

                <!-- Project Details -->
                <div class="space-y-3">
                    <!-- Land Info -->
                    <div class="grid grid-cols-2 gap-2" style="font-size: 0.875rem;">
                        <div>
                            <span class="text-muted-foreground">Type:</span>
                            <span style="color: var(--color-text-main); font-weight: 500;">
                                {{ project.get_land_type_display }}
                            </span>
                        </div>
                        <div>
                            <span class="text-muted-foreground">Size:</span>
                            <span style="color: var(--color-text-main); font-weight: 500;">
                                {{ project.land_size }} m²
                            </span>
                        </div>
                        {% if project.slope %}
                        <div>
                            <span class="text-muted-foreground">Slope:</span>
                            <span style="color: var(--color-text-main); font-weight: 500;">
                                {{ project.get_slope_display }}
                            </span>
                        </div>
                        {% endif %}
                        <div>
                            <span class="text-muted-foreground">Area:</span>
                            <span style="color: var(--color-text-main); font-weight: 500;">
                                {{ project.get_political_classification_display }}
                            </span>
                        </div>
                    </div>

                    <!-- Intended Uses -->
                    {% if project.intended_uses.all %}
                    <div style="margin-top: var(--spacing-2);">
                        <span class="text-muted-foreground"
                            style="font-size: 0.75rem; display: block; margin-bottom: 4px;">Intended Use:</span>
                        <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                            {% for use in project.intended_uses.all %}
                            <span
                                style="display: inline-block; padding: 2px 8px; background: var(--color-primary-100); color: var(--color-primary-600); border-radius: var(--radius-md); font-size: 0.75rem; font-weight: 500;">
                                {{ use.get_name_display }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Infrastructure Icons -->
                    {% if project.has_electricity or project.has_water or project.has_sewage or project.has_paved_road
                    or project.has_internet %}
                    <div style="margin-top: var(--spacing-2);">
                        <span class="text-muted-foreground"
                            style="font-size: 0.75rem; display: block; margin-bottom: 4px;">Infrastructure:</span>
                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                            {% if project.has_electricity %}
                            <span
                                style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 0.7rem;"
                                title="Electricity">⚡</span>
                            {% endif %}
                            {% if project.has_water %}
                            <span
                                style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 0.7rem;"
                                title="Water">💧</span>
                            {% endif %}
                            {% if project.has_sewage %}
                            <span
                                style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 0.7rem;"
                                title="Sewage">🚰</span>
                            {% endif %}
                            {% if project.has_paved_road %}
                            <span
                                style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 0.7rem;"
                                title="Paved Road">🛣️</span>
                            {% endif %}
                            {% if project.has_internet %}
                            <span
                                style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 0.7rem;"
                                title="Internet">📶</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Price and Actions -->
                    <div
                        style="margin-top: var(--spacing-4); padding-top: var(--spacing-4); border-top: 1px solid var(--color-border);">
                        <div class="flex items-center justify-between">
                            <div>
                                {% if project.estimated_price %}
                                <span class="text-sm text-muted-foreground">Estimated Value</span>
                                <div class="text-lg font-bold" style="color: var(--color-primary-500);">
                                    {{ project.estimated_price|floatformat:0|intcomma }}k JOD 
                                </div>
                                {% else %}
                                <span class="text-sm text-muted-foreground">No estimation yet</span>
                                {% endif %}
                                <span class="text-xs text-muted-foreground flex items-center" style="margin-top: 4px;">
                                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        aria-hidden="true">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    {{ project.created_at|date:"Y-m-d" }}

                                </span>
                            </div>
                            <div>
                                <button class="btn btn-primary" style="padding: 8px 16px; font-size: 0.875rem;">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="card card-glass" style="padding: var(--spacing-12); text-align: center;">
        <div style="font-size: 4rem; margin-bottom: var(--spacing-4);">📋</div>
        <h3 class="text-xl font-bold mb-2" style="color: var(--color-text-main);">No projects yet</h3>
        <p class="text-muted-foreground mb-6">Start by creating your first land appraisal project</p>
        <a href="{% url 'normal_user:new-project' %}" class="btn btn-primary"
            style="display: inline-flex; align-items: center; gap: var(--spacing-2);">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                aria-hidden="true">
                <path d="M12 4v16m8-8H4"></path>
            </svg>
            Create New Project
        </a>
    </div>
    {% endif %}
</div>

{% endblock %}
